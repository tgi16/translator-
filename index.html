<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Travel Translator</title>

<style>
:root {
    --primary:#1a73e8;
    --danger:#d93025;
    --bg:#f5f6f7;
    --card:#ffffff;
    --text:#202124;
    --border:#dadce0;
}
[data-theme="dark"]{
    --primary:#8ab4f8;
    --danger:#f28b82;
    --bg:#202124;
    --card:#2d2e31;
    --text:#e8eaed;
    --border:#3c4043;
}
body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:Pyidaungsu,Segoe UI,sans-serif;
    display:flex;
    justify-content:center;
}
.container{
    width:100%;
    max-width:500px;
    padding:12px;
}
.card{
    background:var(--card);
    padding:18px;
    border-radius:20px;
    box-shadow:0 4px 15px rgba(0,0,0,.1);
    text-align:center;
}
#interimText{
    font-size:1.3rem;
    min-height:3em;
    border-bottom:2px dashed var(--border);
    padding:10px;
    margin:15px 0;
}
#pttBtn{
    width:100%;
    padding:22px;
    border:none;
    border-radius:18px;
    font-size:1.1rem;
    font-weight:bold;
    color:#fff;
    background:var(--primary);
}
#pttBtn.active{
    background:var(--danger);
    transform:scale(.96);
}
#pttBtn:disabled{
    background:#999;
}
.typing{
    display:flex;
    gap:8px;
    margin-top:15px;
}
#textInput{
    flex:1;
    padding:14px;
    border-radius:12px;
    border:2px solid var(--border);
    font-size:1rem;
}
.sendBtn{
    padding:0 18px;
    border:none;
    border-radius:12px;
    background:var(--primary);
    color:#fff;
    font-weight:bold;
}
.history{
    margin-top:15px;
    height:320px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:10px;
}
.bubble{
    background:var(--card);
    padding:12px;
    border-radius:16px;
}
.orig{font-size:.85rem;opacity:.7}
.trans{font-size:1.2rem;font-weight:bold}
.tools{
    margin-top:6px;
    font-size:.8rem;
    color:var(--primary);
    font-weight:bold;
}
</style>
</head>

<body>
<div class="container">

<div class="card">
    <h3>Travel Translator</h3>

    <select id="langSelect" style="width:100%;padding:12px;border-radius:12px;">
        <option value="my-MM|ms-MY">ðŸ‡²ðŸ‡² Burmese â†’ ðŸ‡²ðŸ‡¾ Malay</option>
        <option value="ms-MY|my-MM">ðŸ‡²ðŸ‡¾ Malay â†’ ðŸ‡²ðŸ‡² Burmese</option>
        <option value="my-MM|zh-CN">ðŸ‡²ðŸ‡² Burmese â†’ ðŸ‡¨ðŸ‡³ Chinese</option>
        <option value="zh-CN|my-MM">ðŸ‡¨ðŸ‡³ Chinese â†’ ðŸ‡²ðŸ‡² Burmese</option>
    </select>

    <div id="interimText">Hold the button to speak</div>
    <button id="pttBtn">HOLD TO SPEAK</button>

    <div class="typing">
        <input id="textInput" placeholder="á€…á€¬á€›á€­á€¯á€€á€ºá€•á€¼á€®á€¸ á€˜á€¬á€žá€¬á€•á€¼á€”á€ºá€•á€«">
        <button class="sendBtn" onclick="handleTyping()">Send</button>
    </div>
</div>

<div class="history" id="history"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/rabbit-node@1.0.2/rabbit.js"></script>

<script>
/* ---------- GLOBAL ---------- */
const pttBtn = document.getElementById("pttBtn");
const interimBox = document.getElementById("interimText");
const historyBox = document.getElementById("history");
const langSelect = document.getElementById("langSelect");
const textInput = document.getElementById("textInput");

let recognition = null;
let currentText = "";
let isSpeaking = false;

/* ---------- DEVICE DETECT ---------- */
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

/* ---------- NORMALIZE ---------- */
function normalize(t){
    return (window.Rabbit)?Rabbit.zg2uni(t):t;
}

/* ---------- INIT SPEECH (NON-iOS ONLY) ---------- */
function initRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return false;

    recognition = new SR();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = langSelect.value.split("|")[0];

    recognition.onresult = e=>{
        let interim="";
        for(let i=e.resultIndex;i<e.results.length;i++){
            if(e.results[i].isFinal){
                currentText += e.results[i][0].transcript;
            }else{
                interim = e.results[i][0].transcript;
            }
        }
        interimBox.innerText = currentText + interim;
    };

    recognition.onerror = ()=>{
        interimBox.innerText="Mic error";
    };
    return true;
}

/* ---------- PUSH TO TALK ---------- */
if(isIOS){
    pttBtn.disabled = true;
    pttBtn.innerText = "iPhone Safari âŒ Mic";
    interimBox.innerText = "á€…á€¬á€›á€­á€¯á€€á€ºá€•á€¼á€®á€¸á€žá€¬ á€¡á€žá€¯á€¶á€¸á€•á€¼á€¯á€”á€­á€¯á€„á€ºá€•á€«á€á€šá€º";
}else{
    pttBtn.addEventListener("mousedown", startSpeak);
    pttBtn.addEventListener("mouseup", stopSpeak);
    pttBtn.addEventListener("touchstart", startSpeak);
    pttBtn.addEventListener("touchend", stopSpeak);
}

function startSpeak(e){
    e.preventDefault();
    if(isSpeaking) return;
    if(!recognition && !initRecognition()) return;

    currentText="";
    recognition.start();
    pttBtn.classList.add("active");
    interimBox.innerText="Listening...";
}

function stopSpeak(e){
    e.preventDefault();
    if(!recognition) return;
    recognition.stop();
    pttBtn.classList.remove("active");

    setTimeout(()=>{
        const t = interimBox.innerText.trim();
        if(t && t!=="Listening..."){
            translateText(normalize(t));
        }else{
            interimBox.innerText="Hold the button to speak";
        }
    },300);
}

/* ---------- TYPING ---------- */
function handleTyping(){
    const t = textInput.value.trim();
    if(!t) return;
    textInput.value="";
    translateText(normalize(t));
}

/* ---------- TRANSLATE ---------- */
async function translateText(t){
    isSpeaking=true;
    interimBox.innerText="Translating...";
    const [src,tgt]=langSelect.value.split("|");

    try{
        const res = await fetch(
            `https://api.mymemory.translated.net/get?q=${encodeURIComponent(t)}&langpair=${src.split("-")[0]}|${tgt.split("-")[0]}`
        );
        const data = await res.json();
        let out = data.responseData.translatedText;
        if(tgt.startsWith("my")) out = normalize(out);
        addHistory(t,out,tgt);
        speak(out,tgt);
    }catch{
        interimBox.innerText="Error";
        isSpeaking=false;
    }
}

/* ---------- UI ---------- */
function addHistory(o,t,l){
    const d=document.createElement("div");
    d.className="bubble";
    d.innerHTML=`
        <div class="orig">${o}</div>
        <div class="trans">${t}</div>
        <div class="tools" onclick="speak('${t.replace(/'/g,"\\'")}','${l}')">ðŸ”Š REPLAY</div>
    `;
    historyBox.prepend(d);
    interimBox.innerText="Hold the button to speak";
}

/* ---------- SPEAK ---------- */
function speak(t,l){
    const a=new Audio(
        `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(t)}&tl=${l.split("-")[0]}&client=tw-ob`
    );
    a.onended=()=>isSpeaking=false;
    a.play().catch(()=>isSpeaking=false);
}
</script>
</body>
</html>
