<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Gallery</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons (Global) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #475569;
        }
        .cursor-wait {
            cursor: wait;
        }
    </style>

    <!-- Import Map for Modules -->
    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "firebase/app";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInWithEmailAndPassword, signOut } from "firebase/auth";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "firebase/firestore";

        // --- Lucide Icons Wrapper for Standalone HTML ---
        const createIconComponent = (iconName) => ({ size = 24, className, ...props }) => {
            const iconData = lucide.icons[iconName];
            if (!iconData) return null;

            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                    {...props}
                >
                    {iconData.map(([tag, attrs], index) => (
                        React.createElement(tag, { ...attrs, key: index })
                    ))}
                </svg>
            );
        };

        const Plus = createIconComponent('Plus');
        const Trash2 = createIconComponent('Trash2');
        const Copy = createIconComponent('Copy');
        const ImageIcon = createIconComponent('Image'); 
        const X = createIconComponent('X');
        const Check = createIconComponent('Check');
        const Search = createIconComponent('Search');
        const LayoutGrid = createIconComponent('LayoutGrid');
        const ListIcon = createIconComponent('List'); 
        const Maximize2 = createIconComponent('Maximize2');
        const SplitSquareHorizontal = createIconComponent('SplitSquareHorizontal');
        const Star = createIconComponent('Star');
        const Filter = createIconComponent('Filter');
        const Moon = createIconComponent('Moon');
        const Sun = createIconComponent('Sun');
        const Loader2 = createIconComponent('Loader2');
        const AlertCircle = createIconComponent('AlertCircle');
        const LogOut = createIconComponent('LogOut');
        const Mail = createIconComponent('Mail');
        const Lock = createIconComponent('Lock');
        const Users = createIconComponent('Users');
        const Download = createIconComponent('Download');
        const PenTool = createIconComponent('PenTool');

        // --- Firebase Configuration ---
        const userConfig = {
            apiKey: "AIzaSyBzOydmabqVRy84xE8ZusxE544dic6fnYQ",
            authDomain: "prompt-used.firebaseapp.com",
            projectId: "prompt-used",
            storageBucket: "prompt-used.firebasestorage.app",
            messagingSenderId: "18048108420",
            appId: "1:18048108420:web:0e8b9537d1083daa81ffd1"
        };

        const getEnvConfig = () => {
            try {
                if (typeof window !== 'undefined' && window.__firebase_config) {
                    return JSON.parse(window.__firebase_config);
                }
            } catch (e) {
                console.warn("Failed to parse system config, using fallback.");
            }
            return null;
        };

        const firebaseConfig = getEnvConfig() || userConfig;
        
        const getCurrentAppId = () => {
            if (typeof window !== 'undefined' && window.__app_id) {
                return window.__app_id;
            }
            return "prompt-gallery-app";
        };
        
        const currentAppId = getCurrentAppId();

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- SHARED CONFIGURATION ---
        const MAIN_OWNER_UID = "yNcuisZqM4WHwN5RynPDaa1xmNV2"; // Main storage location
        const ALLOWED_UIDS = [
            "yNcuisZqM4WHwN5RynPDaa1xmNV2", // User 1
            "S4hgKzepxJOX7TlleVoAzL6Yxal2"  // User 2
        ];

        const SKETCH_PROMPT_TEXT = "Refrence subject from Image(2), from Image(1) sketch line image to 8k hyper-realsic rendering. don't change image(1) sketch line postion, angel, perceptive and composition. Original camera angle, frame, Position and perceptive don’t change.";

        function App() {
            // --- States ---
            const [user, setUser] = React.useState(null);
            const [prompts, setPrompts] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const [authError, setAuthError] = React.useState(null); 
            
            // Login States
            const [email, setEmail] = React.useState("");
            const [password, setPassword] = React.useState("");
            const [isSigningIn, setIsSigningIn] = React.useState(false);

            // UI States
            const [isDarkMode, setIsDarkMode] = React.useState(false);
            const [inputText, setInputText] = React.useState("");
            const [selectedCategory, setSelectedCategory] = React.useState("General");
            const [genPreviewUrl, setGenPreviewUrl] = React.useState(null); 
            const [refPreviewUrl, setRefPreviewUrl] = React.useState(null); 
            const [copiedId, setCopiedId] = React.useState(null);
            const [selectedPrompt, setSelectedPrompt] = React.useState(null);
            const [searchTerm, setSearchTerm] = React.useState("");
            const [filterCategory, setFilterCategory] = React.useState("All");
            const [showFavoritesOnly, setShowFavoritesOnly] = React.useState(false);
            const [viewMode, setViewMode] = React.useState("list"); 
            const [isUploading, setIsUploading] = React.useState(false);
            
            const genInputRef = React.useRef(null);
            const refInputRef = React.useRef(null);

            const categories = ["General", "Portrait", "Landscape", "Sci-Fi", "Anime", "Art", "Logo", "3D"];

            // --- Firebase Auth & Data Sync ---
            
            React.useEffect(() => {
                const initAuth = async () => {
                    const systemToken = typeof window !== 'undefined' ? window.__initial_auth_token : null;
                    if (systemToken) {
                        try {
                            await signInWithCustomToken(auth, systemToken);
                        } catch (error) {
                            console.error("System Token Auth Failed:", error);
                        }
                    }
                    setIsLoading(false);
                };
                initAuth();
                
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    if (currentUser) {
                        if (ALLOWED_UIDS.includes(currentUser.uid)) {
                            setUser(currentUser);
                            setIsLoading(true);
                            setAuthError(null);
                        } else {
                            console.warn("Unauthorized UID:", currentUser.uid);
                            setAuthError("ဤအကောင့်သည် Shared Gallery ကို အသုံးပြုခွင့်မရှိပါ။");
                            signOut(auth);
                            setUser(null);
                            setIsLoading(false);
                        }
                    } else {
                        setUser(null);
                        setPrompts([]); 
                        setIsLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            React.useEffect(() => {
                if (!user) {
                    setIsLoading(false);
                    return;
                }

                const collectionRef = collection(db, 'artifacts', currentAppId, 'users', MAIN_OWNER_UID, 'prompts');

                const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                    const fetchedPrompts = snapshot.docs.map(doc => {
                        const data = doc.data();
                        const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();
                        return {
                            ...data,
                            id: doc.id,
                            date: createdAt.toLocaleDateString(),
                            timestamp: createdAt.getTime()
                        };
                    });
                    
                    fetchedPrompts.sort((a, b) => b.timestamp - a.timestamp);
                    
                    setPrompts(fetchedPrompts);
                    setIsLoading(false);
                    setAuthError(null);
                }, (error) => {
                    console.error("Firestore Error:", error);
                    setAuthError("Data access error. (Rules များ ပြင်ဆင်ရန် လိုအပ်နိုင်ပါသည်)");
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            // --- Handlers ---

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsSigningIn(true);
                setAuthError(null);
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login Failed:", error);
                    setAuthError("အီးမေးလ် သို့မဟုတ် စကားဝှက် မှားယွင်းနေပါသည်။");
                } finally {
                    setIsSigningIn(false);
                }
            };

            const handleLogout = async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout Error:", error);
                }
            };

            const addSketchPrompt = () => {
                if (inputText.includes(SKETCH_PROMPT_TEXT)) {
                    return;
                }
                const newText = inputText.trim() 
                    ? `${inputText.trim()}\n\n${SKETCH_PROMPT_TEXT}` 
                    : SKETCH_PROMPT_TEXT;
                setInputText(newText);
            };

            const compressImage = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800;
                            const MAX_HEIGHT = 800;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
                            resolve(dataUrl);
                        };
                        img.onerror = (error) => reject(error);
                    };
                    reader.onerror = (error) => reject(error);
                });
            };

            const handleImageUpload = async (e, setPreview) => {
                const file = e.target.files[0];
                if (file) {
                    setIsUploading(true);
                    try {
                        const compressedDataUrl = await compressImage(file);
                        setPreview(compressedDataUrl);
                    } catch (error) {
                        console.error("Image compression error:", error);
                        alert("ပုံတင်ရာတွင် အဆင်မပြေဖြစ်သွားပါသည်။");
                    } finally {
                        setIsUploading(false);
                    }
                }
            };

            const handleAddPrompt = async () => {
                if (!inputText.trim() || !user) return;

                const genSize = genPreviewUrl ? genPreviewUrl.length * 0.75 : 0;
                const refSize = refPreviewUrl ? refPreviewUrl.length * 0.75 : 0;
                
                if (genSize + refSize > 950000) {
                    alert("ပုံ Size ကြီးလွန်းနေပါသည်။ ပုံတစ်ပုံချင်းစီကို ပြန်လည်စစ်ဆေးပါ သို့မဟုတ် ပုံအသစ်ပြန်ရွေးပေးပါ။");
                    return;
                }

                const newPrompt = {
                    text: inputText,
                    generatedImage: genPreviewUrl || "https://placehold.co/600x400/e2e8f0/1e293b?text=No+Image",
                    referenceImage: refPreviewUrl,
                    category: selectedCategory,
                    isFavorite: false,
                    createdAt: serverTimestamp(),
                    date: new Date().toLocaleDateString(),
                    timestamp: Date.now(),
                    author: user.uid
                };

                try {
                    await addDoc(collection(db, 'artifacts', currentAppId, 'users', MAIN_OWNER_UID, 'prompts'), newPrompt);
                    
                    // Reset
                    setInputText("");
                    setSelectedCategory("General");
                    setGenPreviewUrl(null);
                    setRefPreviewUrl(null);
                    if (genInputRef.current) genInputRef.current.value = "";
                    if (refInputRef.current) refInputRef.current.value = "";
                } catch (e) {
                    console.error("Error adding document: ", e);
                    if (e.code === 'resource-exhausted') {
                        alert("Data ပမာဏ များလွန်းနေပါသည်။");
                    } else {
                        alert("သိမ်းဆည်းရာတွင် အဆင်မပြေဖြစ်နေပါသည်။ (Permission Error ဖြစ်နိုင်သည်)");
                    }
                }
            };

            const handleDelete = async (id) => {
                if (!user) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', currentAppId, 'users', MAIN_OWNER_UID, 'prompts', id));
                    if (selectedPrompt?.id === id) setSelectedPrompt(null);
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    alert("ဖျက်ပိုင်ခွင့် မရှိပါ။");
                }
            };

            const toggleFavorite = async (id, e) => {
                e.stopPropagation();
                if (!user) return;
                
                const promptToUpdate = prompts.find(p => p.id === id);
                if (!promptToUpdate) return;

                const updatedPrompts = prompts.map(p => 
                    p.id === id ? { ...p, isFavorite: !p.isFavorite } : p
                );
                setPrompts(updatedPrompts);
                if (selectedPrompt?.id === id) {
                    setSelectedPrompt(prev => ({...prev, isFavorite: !prev.isFavorite}));
                }

                try {
                    const promptRef = doc(db, 'artifacts', currentAppId, 'users', MAIN_OWNER_UID, 'prompts', id);
                    await updateDoc(promptRef, {
                        isFavorite: !promptToUpdate.isFavorite
                    });
                } catch (error) {
                    console.error("Error updating favorite:", error);
                }
            };

            const handleCopy = (text, id) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful && id) {
                        setCopiedId(id);
                        setTimeout(() => setCopiedId(null), 2000);
                    }
                } catch (err) {
                    console.error('Fallback copy failed', err);
                }
                document.body.removeChild(textArea);
            };

            const handleDownload = (imageUrl, fileName) => {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `prompt-gallery-${fileName}-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const filteredPrompts = prompts.filter(prompt => {
                const matchesSearch = prompt.text.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCategory = filterCategory === "All" || prompt.category === filterCategory;
                const matchesFavorite = !showFavoritesOnly || prompt.isFavorite;
                return matchesSearch && matchesCategory && matchesFavorite;
            });

            const theme = {
                bg: isDarkMode ? 'bg-slate-950' : 'bg-slate-50',
                text: isDarkMode ? 'text-slate-100' : 'text-slate-800',
                textSec: isDarkMode ? 'text-slate-400' : 'text-slate-500',
                cardBg: isDarkMode ? 'bg-slate-900' : 'bg-white',
                cardBorder: isDarkMode ? 'border-slate-800' : 'border-slate-200',
                inputBg: isDarkMode ? 'bg-slate-900' : 'bg-white',
                inputBorder: isDarkMode ? 'border-slate-700' : 'border-slate-200',
                headerText: isDarkMode ? 'text-indigo-400' : 'text-indigo-600',
            };

            // --- Render: Login View ---
            if (!user && !isLoading) {
                return (
                    <div className={`min-h-screen font-sans flex items-center justify-center p-4 transition-colors duration-300 ${theme.bg} ${theme.text}`}>
                        <div className={`w-full max-w-md p-8 rounded-2xl shadow-xl border ${theme.cardBg} ${theme.cardBorder}`}>
                            <div className="text-center mb-8">
                                <h1 className={`text-3xl font-bold mb-2 ${theme.headerText}`}>Prompt Gallery</h1>
                                <p className={theme.textSec}>Shared Space Login</p>
                            </div>

                            {authError && (
                                <div className="mb-4 p-3 rounded-lg bg-red-50 text-red-600 text-sm flex items-center gap-2">
                                    <AlertCircle size={16} />
                                    <span>{authError}</span>
                                </div>
                            )}

                            <form onSubmit={handleLogin} className="flex flex-col gap-4">
                                <div>
                                    <label className={`block text-sm font-medium mb-1 ${theme.textSec}`}>Email</label>
                                    <div className="relative">
                                        <Mail className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                        <input 
                                            type="email" 
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            className={`w-full pl-10 p-3 rounded-xl border focus:ring-2 focus:ring-indigo-500 outline-none ${theme.inputBg} ${theme.inputBorder}`}
                                            placeholder="name@example.com"
                                            required
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className={`block text-sm font-medium mb-1 ${theme.textSec}`}>Password</label>
                                    <div className="relative">
                                        <Lock className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                        <input 
                                            type="password" 
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            className={`w-full pl-10 p-3 rounded-xl border focus:ring-2 focus:ring-indigo-500 outline-none ${theme.inputBg} ${theme.inputBorder}`}
                                            placeholder="••••••••"
                                            required
                                        />
                                    </div>
                                </div>
                                <button 
                                    type="submit" 
                                    disabled={isSigningIn}
                                    className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all disabled:opacity-50 flex justify-center gap-2"
                                >
                                    {isSigningIn && <Loader2 className="animate-spin" />}
                                    {isSigningIn ? "ဝင်ရောက်နေသည်..." : "Login ဝင်မည်"}
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // --- Render: Main App ---
            return (
                <div className={`min-h-screen font-sans p-4 md:p-8 transition-colors duration-300 ${theme.bg} ${theme.text}`}>
                    <div className="max-w-6xl mx-auto">
                        
                        <header className="mb-8 flex items-center justify-between">
                            <button 
                                onClick={handleLogout}
                                className={`p-2 rounded-full transition-all ${isDarkMode ? 'bg-slate-800 hover:bg-slate-700 text-slate-400' : 'bg-white hover:bg-slate-100 text-slate-500 shadow-sm border border-slate-200'}`}
                                title="Logout"
                            >
                                <LogOut size={20} />
                            </button>

                            <div className="text-center">
                                <h1 className={`text-3xl font-bold mb-2 ${theme.headerText}`}>Prompt Gallery</h1>
                                <div className={`flex items-center justify-center gap-2 ${theme.textSec}`}>
                                    <Users size={16} />
                                    <p>Shared Gallery</p>
                                </div>
                            </div>
                            
                            <button 
                                onClick={() => setIsDarkMode(!isDarkMode)}
                                className={`p-2.5 rounded-full transition-all ${isDarkMode ? 'bg-slate-800 text-yellow-400 hover:bg-slate-700' : 'bg-white text-slate-600 hover:bg-slate-100 shadow-sm border border-slate-200'}`}
                                title={isDarkMode ? "Switch to Light Mode" : "Switch to Dark Mode"}
                            >
                                {isDarkMode ? <Sun size={20} /> : <Moon size={20} />}
                            </button>
                        </header>

                        {/* Error Alert Banner */}
                        {authError && (
                            <div className="mb-6 p-4 rounded-xl bg-red-50 border border-red-200 flex items-start gap-3">
                                <AlertCircle className="text-red-500 shrink-0 mt-0.5" size={20} />
                                <div>
                                    <h3 className="text-red-800 font-semibold text-sm">Data Access Error</h3>
                                    <p className="text-red-600 text-xs mt-1">{authError}</p>
                                </div>
                            </div>
                        )}

                        <div className={`rounded-2xl shadow-sm p-6 mb-8 border transition-colors duration-300 ${theme.cardBg} ${theme.cardBorder}`}>
                            <div className="flex flex-col gap-6">
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                                            Reference ပုံ (Optional)
                                        </label>
                                        <div 
                                            onClick={() => !isUploading && refInputRef.current.click()}
                                            className={`border-2 border-dashed rounded-xl h-32 flex flex-col items-center justify-center cursor-pointer transition-all relative overflow-hidden
                                                ${refPreviewUrl 
                                                ? 'border-indigo-500/50' 
                                                : isDarkMode ? 'border-slate-700 hover:border-slate-600 hover:bg-slate-800' : 'border-slate-200 hover:border-indigo-300 hover:bg-slate-50'}
                                                ${isUploading ? 'opacity-50 cursor-wait' : ''}
                                            `}
                                        >
                                            {isUploading && !refPreviewUrl ? (
                                                <div className="flex flex-col items-center">
                                                    <Loader2 className="animate-spin text-indigo-500 mb-2" size={24} />
                                                    <span className="text-xs text-indigo-500">Compressing...</span>
                                                </div>
                                            ) : refPreviewUrl ? (
                                                <img src={refPreviewUrl} alt="Ref Preview" className="h-full w-full object-contain" />
                                            ) : (
                                                <div className="text-center p-2">
                                                    <SplitSquareHorizontal className={`w-6 h-6 mx-auto mb-1 ${isDarkMode ? 'text-slate-600' : 'text-slate-400'}`} />
                                                    <span className={`text-xs ${isDarkMode ? 'text-slate-500' : 'text-slate-400'}`}>Reference ပုံ</span>
                                                </div>
                                            )}
                                            <input type="file" ref={refInputRef} onChange={(e) => handleImageUpload(e, setRefPreviewUrl)} accept="image/*" className="hidden" disabled={isUploading} />
                                        </div>
                                    </div>

                                    <div>
                                        <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                                            Prompt ရလဒ်ပုံ <span className="text-red-500">*</span>
                                        </label>
                                        <div 
                                            onClick={() => !isUploading && genInputRef.current.click()}
                                            className={`border-2 border-dashed rounded-xl h-32 flex flex-col items-center justify-center cursor-pointer transition-all relative overflow-hidden
                                                ${genPreviewUrl 
                                                ? 'border-indigo-500' 
                                                : isDarkMode ? 'border-slate-700 hover:border-slate-600 hover:bg-slate-800' : 'border-slate-300 hover:border-indigo-400 hover:bg-slate-50'}
                                                ${isUploading ? 'opacity-50 cursor-wait' : ''}
                                            `}
                                        >
                                            {isUploading && !genPreviewUrl ? (
                                                <div className="flex flex-col items-center">
                                                    <Loader2 className="animate-spin text-indigo-500 mb-2" size={24} />
                                                    <span className="text-xs text-indigo-500">Compressing...</span>
                                                </div>
                                            ) : genPreviewUrl ? (
                                                <img src={genPreviewUrl} alt="Generated Preview" className="h-full w-full object-contain" />
                                            ) : (
                                                <div className="text-center p-2">
                                                    <ImageIcon className={`w-6 h-6 mx-auto mb-1 ${isDarkMode ? 'text-slate-600' : 'text-slate-400'}`} />
                                                    <span className={`text-xs ${isDarkMode ? 'text-slate-500' : 'text-slate-400'}`}>ရလဒ်ပုံ</span>
                                                </div>
                                            )}
                                            <input type="file" ref={genInputRef} onChange={(e) => handleImageUpload(e, setGenPreviewUrl)} accept="image/*" className="hidden" disabled={isUploading} />
                                        </div>
                                    </div>
                                </div>

                                {/* Text Inputs */}
                                <div className="flex flex-col gap-3">
                                    <div className="flex justify-between items-center">
                                        <div className="flex gap-2 items-center flex-1">
                                            <select 
                                                value={selectedCategory}
                                                onChange={(e) => setSelectedCategory(e.target.value)}
                                                className={`p-2 rounded-lg border text-sm focus:ring-2 focus:ring-indigo-500 outline-none ${theme.inputBg} ${theme.inputBorder} ${theme.text}`}
                                            >
                                                {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                            </select>
                                            <span className={`text-xs ${theme.textSec}`}>Category ရွေးရန်</span>
                                        </div>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={addSketchPrompt}
                                                className={`text-xs flex items-center gap-1 px-3 py-1.5 rounded-lg border transition-colors
                                                    ${isDarkMode ? 'border-slate-700 hover:bg-slate-800 text-teal-400' : 'border-slate-200 hover:bg-teal-50 text-teal-600'}
                                                `}
                                                title="Add Sketch Prompt"
                                            >
                                                <PenTool size={14} />
                                                <span>Sketch Prompt</span>
                                            </button>
                                        </div>
                                    </div>

                                    <textarea
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                        placeholder="ဒီပုံအတွက် သုံးထားတဲ့ Prompt ကို ရေးပါ..."
                                        className={`w-full p-3 rounded-xl border focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none h-20 resize-none text-sm font-mono transition-colors
                                            ${theme.inputBg} ${theme.inputBorder} ${theme.text} placeholder:text-slate-500
                                        `}
                                    />

                                    <button
                                        onClick={handleAddPrompt}
                                        disabled={!inputText.trim() || isUploading}
                                        className={`w-full py-2.5 rounded-xl flex items-center justify-center gap-2 font-semibold transition-all text-sm
                                            ${inputText.trim() && !isUploading
                                                ? 'bg-indigo-600 text-white hover:bg-indigo-700 hover:shadow-md transform hover:-translate-y-0.5' 
                                                : `${isDarkMode ? 'bg-slate-800 text-slate-600' : 'bg-slate-200 text-slate-400'} cursor-not-allowed`}
                                        `}
                                    >
                                        {isUploading ? <Loader2 className="animate-spin" size={18} /> : <Plus size={18} />}
                                        <span>သိမ်းဆည်းမည်</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Search & Filter Bar */}
                        <div className={`flex flex-col lg:flex-row justify-between items-center gap-4 mb-6 sticky top-2 z-10 backdrop-blur-md py-3 px-4 rounded-2xl border shadow-sm transition-colors duration-300
                            ${isDarkMode ? 'bg-slate-900/90 border-slate-700' : 'bg-slate-50/95 border-white/50'}
                        `}>
                            <div className="relative w-full lg:w-96">
                                <Search className={`absolute left-3 top-1/2 -translate-y-1/2 ${theme.textSec}`} size={18} />
                                <input
                                    type="text"
                                    placeholder="Prompt များ ရှာရန်..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className={`w-full pl-10 pr-4 py-2 rounded-xl border focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none text-sm shadow-sm transition-colors
                                        ${isDarkMode ? 'bg-slate-800 border-slate-700 text-slate-200 placeholder:text-slate-500' : 'bg-white border-slate-200 text-slate-800'}
                                    `}
                                />
                            </div>

                            <div className="flex flex-wrap items-center gap-3 w-full lg:w-auto justify-end">
                                <div className={`flex items-center gap-2 px-3 py-1.5 rounded-xl border shadow-sm transition-colors ${theme.cardBg} ${theme.cardBorder}`}>
                                    <Filter size={14} className={theme.textSec} />
                                    <select 
                                        value={filterCategory}
                                        onChange={(e) => setFilterCategory(e.target.value)}
                                        className={`text-sm bg-transparent border-none outline-none cursor-pointer min-w-[80px] ${theme.textSec}`}
                                    >
                                        <option value="All">All Categories</option>
                                        {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                    </select>
                                </div>

                                <button
                                    onClick={() => setShowFavoritesOnly(!showFavoritesOnly)}
                                    className={`flex items-center gap-1.5 px-3 py-1.5 rounded-xl border text-sm transition-all shadow-sm
                                        ${showFavoritesOnly 
                                            ? 'bg-amber-500/10 border-amber-500/30 text-amber-500' 
                                            : `${theme.cardBg} ${theme.cardBorder} ${theme.textSec} hover:bg-opacity-80`}
                                    `}
                                >
                                    <Star size={14} fill={showFavoritesOnly ? "currentColor" : "none"} />
                                    <span>Favorites</span>
                                </button>

                                <div className={`flex rounded-xl p-1 border shadow-sm ml-2 ${theme.cardBg} ${theme.cardBorder}`}>
                                    <button 
                                        onClick={() => setViewMode('grid')} 
                                        className={`p-1.5 rounded-lg transition-all ${viewMode === 'grid' ? 'bg-indigo-500/10 text-indigo-500' : `${theme.textSec} hover:bg-slate-100/10`}`}
                                        title="Grid View"
                                    >
                                        <LayoutGrid size={16} />
                                    </button>
                                    <button 
                                        onClick={() => setViewMode('list')} 
                                        className={`p-1.5 rounded-lg transition-all ${viewMode === 'list' ? 'bg-indigo-500/10 text-indigo-500' : `${theme.textSec} hover:bg-slate-100/10`}`}
                                        title="List View"
                                    >
                                        <ListIcon size={16} />
                                    </button>
                                </div>
                            </div>
                        </div>

                        {isLoading && (
                            <div className="flex justify-center py-12">
                                <Loader2 className={`animate-spin ${theme.textSec}`} size={32} />
                            </div>
                        )}

                        {!isLoading && (
                            <div className={viewMode === 'grid' 
                                ? "grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4" 
                                : "flex flex-col gap-3" 
                            }>
                                {filteredPrompts.map((item) => (
                                    viewMode === 'grid' ? (
                                        <div 
                                            key={item.id} 
                                            className={`rounded-xl shadow-sm border overflow-hidden transition-all group cursor-pointer aspect-square relative
                                                ${isDarkMode ? 'bg-slate-800 border-slate-700 hover:border-indigo-500/50' : 'bg-white border-slate-200 hover:shadow-md hover:border-indigo-300'}
                                            `}
                                            onClick={() => setSelectedPrompt(item)}
                                        >
                                            <img src={item.generatedImage} alt="Generated result" className="w-full h-full object-cover" />
                                            
                                            <div className="absolute top-1 left-1 right-1 flex justify-between items-start pointer-events-none">
                                                <span className="bg-black/50 backdrop-blur-sm px-1.5 py-0.5 rounded text-[9px] text-white font-medium border border-white/10">
                                                    {item.category || "General"}
                                                </span>

                                                <div className="flex gap-1">
                                                    {item.referenceImage && (
                                                    <span className="bg-black/50 backdrop-blur-sm p-1 rounded-full text-white">
                                                        <SplitSquareHorizontal size={8} />
                                                    </span>
                                                    )}
                                                    {item.isFavorite && (
                                                    <span className="bg-amber-400 p-1 rounded-full text-white shadow-sm">
                                                        <Star size={8} fill="currentColor" />
                                                    </span>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                                        </div>
                                    ) : (
                                        <div 
                                            key={item.id} 
                                            onClick={() => setSelectedPrompt(item)}
                                            className={`rounded-xl shadow-sm border p-3 flex gap-4 items-center transition-all cursor-pointer group
                                                ${isDarkMode ? 'bg-slate-900 border-slate-800 hover:border-indigo-500/30' : 'bg-white border-slate-200 hover:shadow-md hover:border-indigo-200'}
                                            `}
                                        >
                                            <div className={`w-16 h-16 sm:w-20 sm:h-20 flex-shrink-0 rounded-lg overflow-hidden relative border ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-100 border-slate-100'}`}>
                                                <img src={item.generatedImage} alt="Thumbnail" className="w-full h-full object-cover" />
                                                {item.referenceImage && (
                                                    <div className="absolute bottom-0 right-0 bg-indigo-600 p-1 rounded-tl-md">
                                                        <SplitSquareHorizontal size={10} className="text-white" />
                                                    </div>
                                                )}
                                            </div>

                                            <div className="flex-grow min-w-0 flex flex-col justify-center h-full gap-1">
                                                <div className="flex items-center gap-2 mb-0.5">
                                                    <span className={`text-[10px] uppercase font-bold tracking-wider px-1.5 py-0.5 rounded border 
                                                        ${isDarkMode ? 'bg-indigo-900/30 text-indigo-300 border-indigo-500/20' : 'text-indigo-500 bg-indigo-50 border-indigo-100'}
                                                    `}>
                                                        {item.category || "General"}
                                                    </span>
                                                    <span className={`text-xs ${theme.textSec}`}>{item.date}</span>
                                                </div>
                                                <p className={`text-sm font-mono truncate w-full transition-colors ${isDarkMode ? 'text-slate-300 group-hover:text-indigo-400' : 'text-slate-700 group-hover:text-indigo-600'}`}>
                                                    {item.text}
                                                </p>
                                            </div>

                                            <div className={`flex items-center gap-2 ${isDarkMode ? 'text-slate-600' : 'text-slate-300'}`}>
                                                <button 
                                                    onClick={(e) => toggleFavorite(item.id, e)}
                                                    className={`p-1.5 rounded-full hover:bg-opacity-10 transition-colors ${item.isFavorite ? 'text-amber-400' : 'hover:text-amber-400 hover:bg-slate-500'}`}
                                                    title="Add to Favorites"
                                                >
                                                    <Star size={18} fill={item.isFavorite ? "currentColor" : "none"} />
                                                </button>
                                                <div className="group-hover:text-indigo-400 px-1">
                                                    <Maximize2 size={16} />
                                                </div>
                                            </div>
                                        </div>
                                    )
                                ))}
                            </div>
                        )}

                        {selectedPrompt && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
                                <div className={`rounded-3xl shadow-2xl max-w-6xl w-full max-h-[95vh] overflow-hidden flex flex-col md:flex-row relative animate-in zoom-in-95 duration-200 ${isDarkMode ? 'bg-slate-900' : 'bg-white'}`}>
                                    
                                    <button 
                                        onClick={() => setSelectedPrompt(null)}
                                        className="absolute top-4 right-4 z-10 bg-black/20 hover:bg-black/40 text-white p-2 rounded-full backdrop-blur-md transition-colors"
                                    >
                                        <X size={20} />
                                    </button>

                                    {/* Image Section */}
                                    <div className={`flex-1 overflow-y-auto custom-scrollbar p-6 flex flex-col gap-4 ${!selectedPrompt.referenceImage ? 'justify-center' : ''} ${isDarkMode ? 'bg-black/50' : 'bg-slate-900'}`}>
                                        
                                        {/* Generated Image - Primary */}
                                        <div className="flex-1 flex flex-col min-h-[60%] relative group/img">
                                            <div className="flex justify-between items-center mb-2 px-1">
                                                <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Generated Result</span>
                                                <button 
                                                    onClick={() => handleDownload(selectedPrompt.generatedImage, 'generated')}
                                                    className="bg-black/50 hover:bg-black/70 text-white text-xs px-2 py-1 rounded flex items-center gap-1 transition-colors"
                                                >
                                                    <Download size={12} /> Download
                                                </button>
                                            </div>
                                            <img 
                                                src={selectedPrompt.generatedImage} 
                                                alt="Generated" 
                                                className="w-full h-full object-contain rounded-lg shadow-lg bg-slate-800 ring-1 ring-white/10" 
                                            />
                                        </div>

                                        {/* Reference Image - Secondary */}
                                        {selectedPrompt.referenceImage && (
                                            <div className="h-40 shrink-0 flex flex-col pt-4 border-t border-slate-700/50">
                                                <div className="flex justify-between items-center mb-2 px-1">
                                                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Original Reference</span>
                                                </div>
                                                <img 
                                                    src={selectedPrompt.referenceImage} 
                                                    alt="Reference" 
                                                    className="w-full h-full object-contain rounded-lg shadow-sm opacity-60 hover:opacity-100 transition-opacity bg-slate-800/50" 
                                                />
                                            </div>
                                        )}
                                    </div>

                                    {/* Details Section */}
                                    <div className={`w-full md:w-[450px] p-6 flex flex-col border-l ${isDarkMode ? 'bg-slate-900 text-slate-200 border-slate-800' : 'bg-white text-slate-800 border-slate-100'}`}>
                                        <div className="flex-grow overflow-y-auto custom-scrollbar pr-2">
                                            <div className="flex justify-between items-start mb-1">
                                                <h3 className="text-xl font-bold">Prompt Details</h3>
                                                <button 
                                                    onClick={(e) => toggleFavorite(selectedPrompt.id, e)}
                                                    className={`p-1 rounded-full transition-colors ${selectedPrompt.isFavorite ? 'text-amber-400' : `${isDarkMode ? 'text-slate-600 hover:text-amber-400 hover:bg-slate-800' : 'text-slate-300 hover:text-amber-400 hover:bg-slate-50'}`}`}
                                                >
                                                    <Star size={24} fill={selectedPrompt.isFavorite ? "currentColor" : "none"} />
                                                </button>
                                            </div>
                                            
                                            <div className="flex flex-wrap gap-2 mb-6">
                                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${isDarkMode ? 'bg-indigo-900/50 text-indigo-300' : 'bg-indigo-100 text-indigo-700'}`}>
                                                    {selectedPrompt.category || "General"}
                                                </span>
                                                <p className={`text-sm flex items-center ${theme.textSec} ml-auto`}>{selectedPrompt.date}</p>
                                            </div>
                                            
                                            <div className={`p-5 rounded-xl border shadow-inner mb-4 ${isDarkMode ? 'bg-slate-950 border-slate-800' : 'bg-slate-50 border-slate-100'}`}>
                                                <p className={`text-sm font-mono leading-relaxed whitespace-pre-wrap select-all ${isDarkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                                                    {selectedPrompt.text}
                                                </p>
                                            </div>
                                        </div>

                                        <div className={`mt-6 pt-6 border-t flex flex-col gap-3 ${isDarkMode ? 'border-slate-800' : 'border-slate-100'}`}>
                                            <div className="flex gap-2">
                                                <button 
                                                    onClick={() => handleCopy(selectedPrompt.text, selectedPrompt.id)}
                                                    className={`flex-1 py-3 rounded-xl flex items-center justify-center gap-2 font-medium transition-all
                                                        ${copiedId === selectedPrompt.id 
                                                            ? 'bg-green-600 text-white' 
                                                            : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-md hover:shadow-lg'}
                                                    `}
                                                >
                                                    {copiedId === selectedPrompt.id ? <Check size={18} /> : <Copy size={18} />}
                                                    {copiedId === selectedPrompt.id ? 'Copied!' : 'Copy Prompt'}
                                                </button>
                                            </div>

                                            <button 
                                                onClick={() => handleDelete(selectedPrompt.id)}
                                                className={`w-full py-3 rounded-xl flex items-center justify-center gap-2 font-medium transition-colors text-sm
                                                    ${isDarkMode ? 'text-red-400 hover:bg-red-900/20' : 'text-red-500 hover:bg-red-50'}
                                                `}
                                            >
                                                <Trash2 size={16} /> Delete Entry
                                            </button>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>